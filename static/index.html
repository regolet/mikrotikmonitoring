<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroTik Monitoring</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">MikroTik Monitoring</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Refresh Controls -->
        <div class="row mb-3">
            <div class="col-md-12 text-end">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                        Auto-refresh: <span id="refresh-interval-display">Off</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item refresh-option" href="#" data-interval="0">Off</a></li>
                        <li><a class="dropdown-item refresh-option" href="#" data-interval="5">5 seconds</a></li>
                        <li><a class="dropdown-item refresh-option" href="#" data-interval="10">10 seconds</a></li>
                        <li><a class="dropdown-item refresh-option" href="#" data-interval="30">30 seconds</a></li>
                        <li><a class="dropdown-item refresh-option" href="#" data-interval="60">1 minute</a></li>
                    </ul>
                </div>
                <button id="refresh-now" class="btn btn-primary me-2">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Now
                </button>
                <button id="export-data" class="btn btn-success me-2">
                    <i class="bi bi-download"></i> Export Data
                </button>
                <button id="test-notification" class="btn btn-info">
                    <i class="bi bi-bell"></i> Test Notifications
                </button>
            </div>
        </div>

        <!-- Network Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Network Summary</h3>
            </div>
            <div class="card-body">
                <div class="seven-cards-row">
                    <div class="stat-card-wrapper">
                        <div class="stat-card horizontal-card">
                            <div class="icon-circle">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <div class="card-content">
                                <h3 class="mb-0" id="total-accounts">-</h3>
                                <p class="mb-0">Total Accounts</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card-wrapper">
                        <div class="stat-card horizontal-card bg-success bg-opacity-10">
                            <div class="icon-circle bg-success bg-opacity-25">
                                <i class="bi bi-wifi text-success"></i>
                            </div>
                            <div class="card-content">
                                <h3 class="mb-0 text-success" id="online-accounts">-</h3>
                                <p class="mb-0">Online</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card-wrapper">
                        <div class="stat-card horizontal-card bg-danger bg-opacity-10">
                            <div class="icon-circle bg-danger bg-opacity-25">
                                <i class="bi bi-wifi-off text-danger"></i>
                            </div>
                            <div class="card-content">
                                <h3 class="mb-0 text-danger" id="offline-accounts">-</h3>
                                <p class="mb-0">Offline</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card-wrapper">
                        <div class="stat-card horizontal-card bg-info bg-opacity-10">
                            <div class="icon-circle bg-info bg-opacity-25">
                                <i class="bi bi-toggle-on text-info"></i>
                            </div>
                            <div class="card-content">
                                <h3 class="mb-0 text-info" id="enabled-accounts">-</h3>
                                <p class="mb-0">Enabled</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card-wrapper">
                        <div class="stat-card horizontal-card bg-secondary bg-opacity-10">
                            <div class="icon-circle bg-secondary bg-opacity-25">
                                <i class="bi bi-toggle-off text-secondary"></i>
                            </div>
                            <div class="card-content">
                                <h3 class="mb-0 text-secondary" id="disabled-accounts">-</h3>
                                <p class="mb-0">Disabled</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card-wrapper">
                        <div class="stat-card horizontal-card bg-primary bg-opacity-10">
                            <div class="icon-circle bg-primary bg-opacity-25">
                                <i class="bi bi-cloud-arrow-up text-primary"></i>
                            </div>
                            <div class="card-content">
                                <h3 class="mb-0 text-primary" id="total-upload-speed">-</h3>
                                <p class="mb-0">Total Upload Speed</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card-wrapper">
                        <div class="stat-card horizontal-card bg-warning bg-opacity-10">
                            <div class="icon-circle bg-warning bg-opacity-25">
                                <i class="bi bi-cloud-arrow-down text-warning"></i>
                            </div>
                            <div class="card-content">
                                <h3 class="mb-0 text-warning" id="total-download-speed">-</h3>
                                <p class="mb-0">Total Download Speed</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-end">
                        <small class="text-muted">Last updated: <span id="last-updated-time">-</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Resources -->
        <div id="resources-section" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <h3>System Resources</h3>
                </div>
                <div class="card-body">
                    <div class="row" id="resources-content">
                        <!-- Resources will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Two-column layout for Network Interfaces and PPP Active Connections -->
        <div class="row">
            <div class="col-md-6">
                <!-- Network Interfaces -->
                <div id="interfaces-section" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3>Network Interfaces</h3>
                            <div>
                                <select id="interface-filter" class="form-select form-select-sm">
                                    <option value="all">Show All</option>
                                    <option value="no-pppoe" selected>Hide PPPoE</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="network-interfaces-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>MAC Address</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Interfaces will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    Showing <span id="interfaces-showing-start">0</span> to <span id="interfaces-showing-end">0</span> of <span id="interfaces-total-rows">0</span> entries
                                </div>
                                <div>
                                    <nav aria-label="Interfaces table navigation">
                                        <ul class="pagination pagination-sm mb-0">
                                            <li class="page-item">
                                                <button id="interfaces-prev-page" class="page-link" aria-label="Previous">
                                                    <span aria-hidden="true">&laquo;</span>
                                                </button>
                                            </li>
                                            <li class="page-item">
                                                <span class="page-link">Page <span id="interfaces-current-page">1</span></span>
                                            </li>
                                            <li class="page-item">
                                                <button id="interfaces-next-page" class="page-link" aria-label="Next">
                                                    <span aria-hidden="true">&raquo;</span>
                                                </button>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- PPP Active Connections -->
                <div id="ppp-active-section" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3>Active PPP Connections</h3>
                        </div>
                        <div class="card-body">
                            <div id="ppp-active-content">
                                <!-- PPP active connections will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    Showing <span id="ppp-active-showing-start">0</span> to <span id="ppp-active-showing-end">0</span> of <span id="ppp-active-total-rows">0</span> entries
                                </div>
                                <div>
                                    <nav aria-label="PPP Active table navigation">
                                        <ul class="pagination pagination-sm mb-0">
                                            <li class="page-item">
                                                <button id="ppp-active-prev-page" class="page-link" aria-label="Previous">
                                                    <span aria-hidden="true">&laquo;</span>
                                                </button>
                                            </li>
                                            <li class="page-item">
                                                <span class="page-link">Page <span id="ppp-active-current-page">1</span></span>
                                            </li>
                                            <li class="page-item">
                                                <button id="ppp-active-next-page" class="page-link" aria-label="Next">
                                                    <span aria-hidden="true">&raquo;</span>
                                                </button>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PPPoE Interfaces -->
        <div id="pppoe-section" style="display: none;">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>PPPoE Interfaces</h3>
                    <div>
                        <select id="pppoe-rows-per-page" class="form-select form-select-sm">
                            <option value="10">10 rows</option>
                            <option value="20" selected>20 rows</option>
                            <option value="50">50 rows</option>
                            <option value="100">100 rows</option>
                            <option value="0">All</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm" id="pppoe-interfaces-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Profile Plan</th>
                                    <th>Status</th>
                                    <th>Download (TX)</th>
                                    <th>Upload (RX)</th>
                                    <th>Address</th>
                                    <th>Uptime</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- PPPoE interfaces will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            Showing <span id="pppoe-showing-start">0</span> to <span id="pppoe-showing-end">0</span> of <span id="pppoe-total-rows">0</span> entries
                        </div>
                        <div>
                            <nav aria-label="PPPoE table navigation">
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item">
                                        <button id="pppoe-prev-page" class="page-link" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </button>
                                    </li>
                                    <li class="page-item">
                                        <span class="page-link">Page <span id="pppoe-current-page">1</span></span>
                                    </li>
                                    <li class="page-item">
                                        <button id="pppoe-next-page" class="page-link" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PPP Accounts -->
        <div id="ppp-accounts-section" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <h3>PPP Accounts</h3>
                </div>
                <div class="card-body">
                    <div id="ppp-accounts-content">
                        <!-- PPP accounts will be populated by JavaScript -->
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            Showing <span id="ppp-accounts-showing-start">0</span> to <span id="ppp-accounts-showing-end">0</span> of <span id="ppp-accounts-total-rows">0</span> entries
                        </div>
                        <div>
                            <nav aria-label="PPP Accounts table navigation">
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item">
                                        <button id="ppp-accounts-prev-page" class="page-link" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </button>
                                    </li>
                                    <li class="page-item">
                                        <span class="page-link">Page <span id="ppp-accounts-current-page">1</span></span>
                                    </li>
                                    <li class="page-item">
                                        <button id="ppp-accounts-next-page" class="page-link" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Notification Container -->
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;"></div>

    <footer class="footer mt-5">
        <div class="container text-center py-3">
            <p>MikroTik Monitoring &copy; 2024</p>
            <p class="text-muted">Last updated: <span id="footer-time">-</span></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Bootstrap Toast Notification Helper
    function showToast(message, type = 'info', title = '') {
        const toastId = 'toast-' + Date.now();
        const icon = type === 'success' ? 'bi-check-circle-fill' : type === 'error' ? 'bi-x-circle-fill' : type === 'warning' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill';
        const header = title ? `<strong class="me-auto"><i class="bi ${icon} me-2"></i>${title}</strong>` : '';
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${header}
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>`;
        const container = document.getElementById('toast-container');
        container.insertAdjacentHTML('beforeend', toastHtml);
        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }
    // Simple aliases for compatibility
    window.showSuccess = (title, message) => showToast(message, 'success', title);
    window.showError = (title, message) => showToast(message, 'danger', title);
    window.showWarning = (title, message) => showToast(message, 'warning', title);
    window.showInfo = (title, message) => showToast(message, 'info', title);
    </script>

    <!-- Main Application Logic -->
    <script>
        class MikroTikMonitor {
            constructor() {
                this.refreshInterval = null;
                this.currentData = {};
                this.interfacesPage = 1;
                this.pppAccountsPage = 1;
                this.pppActivePage = 1;
                this.rowsPerPage = 20;
                this.pppoePage = 1;
                this.init();
                // Instantly load all data on creation
                this.refreshAllData();
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Refresh controls
                document.getElementById('refresh-now').addEventListener('click', () => {
                    this.refreshAllData();
                });

                document.getElementById('export-data').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('test-notification').addEventListener('click', () => {
                    this.testNotifications();
                });

                // Auto-refresh options
                document.querySelectorAll('.refresh-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const interval = parseInt(e.target.dataset.interval);
                        this.setRefreshInterval(interval);
                    });
                });

                // Interface filter
                document.getElementById('interface-filter').addEventListener('change', () => {
                    this.applyInterfaceFilter();
                });
            }

            async loadInitialData() {
                await this.checkConnection();
                if (this.currentData.connected) {
                    await this.refreshAllData();
                }
            }

            async checkConnection() {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    
                    this.currentData.connected = data.connected;
                    
                    if (data.connected) {
                        showSuccess('Connected', 'Successfully connected to MikroTik router');
                    } else {
                        showError('Connection Failed', 'Unable to connect to MikroTik router');
                    }
                } catch (error) {
                    console.error('Error checking connection:', error);
                    showError('Connection Error', 'Failed to connect to server');
                }
            }

            async refreshAllData() {
                // Show loading placeholders for each section
                this.showLoadingPlaceholders();
                // Fetch and render each section independently
                this.fetchAndRenderResources();
                this.fetchAndRenderInterfaces();
                this.fetchAndRenderPPPoE();
                this.fetchAndRenderPPPActive();
                this.fetchAndRenderPPPAccounts();
            }

            showLoadingPlaceholders() {
                // Resources
                const resourcesSection = document.getElementById('resources-section');
                const resourcesContent = document.getElementById('resources-content');
                if (resourcesSection && resourcesContent) {
                    resourcesSection.style.display = 'block';
                    // Only show loading if no current data
                    if (!this.currentData.resources) {
                        resourcesContent.innerHTML = '<div class="text-center text-muted py-4">Loading system resources...</div>';
                    }
                }
                // Interfaces
                const interfacesSection = document.getElementById('interfaces-section');
                const interfacesTbody = document.querySelector('#network-interfaces-table tbody');
                if (interfacesSection && interfacesTbody) {
                    interfacesSection.style.display = 'block';
                    // Only show loading if no current data
                    if (!this.currentData.interfaces || this.currentData.interfaces.length === 0) {
                        interfacesTbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Loading interfaces...</td></tr>';
                    }
                }
                // PPPoE
                const pppoeSection = document.getElementById('pppoe-section');
                const pppoeTbody = document.querySelector('#pppoe-interfaces-table tbody');
                if (pppoeSection && pppoeTbody) {
                    pppoeSection.style.display = 'block';
                    // Only show loading if no current data
                    if (!this.currentData.pppoe || !this.currentData.pppoe.pppoe_interfaces || this.currentData.pppoe.pppoe_interfaces.length === 0) {
                        pppoeTbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Loading PPPoE interfaces...</td></tr>';
                    }
                }
                // PPP Active
                const pppActiveSection = document.getElementById('ppp-active-section');
                const pppActiveContent = document.getElementById('ppp-active-content');
                if (pppActiveSection && pppActiveContent) {
                    pppActiveSection.style.display = 'block';
                    // Only show loading if no current data
                    if (!this.currentData.ppp_active || this.currentData.ppp_active.length === 0) {
                        pppActiveContent.innerHTML = '<div class="text-center text-muted py-4">Loading active PPP connections...</div>';
                    }
                }
                // PPP Accounts
                const pppAccountsSection = document.getElementById('ppp-accounts-section');
                const pppAccountsContent = document.getElementById('ppp-accounts-content');
                if (pppAccountsSection && pppAccountsContent) {
                    pppAccountsSection.style.display = 'block';
                    // Only show loading if no current data
                    if (!this.currentData.ppp_accounts || this.currentData.ppp_accounts.length === 0) {
                        pppAccountsContent.innerHTML = '<div class="text-center text-muted py-4">Loading PPP accounts...</div>';
                    }
                }
            }

            async fetchAndRenderResources() {
                try {
                    const response = await fetch('/api/resources');
                    const data = await response.json();
                    this.currentData.resources = data.success ? data.resources : null;
                    this.updateResources();
                } catch (error) {
                    this.currentData.resources = null;
                    this.updateResources();
                }
            }

            async fetchAndRenderInterfaces() {
                try {
                    const response = await fetch('/api/interfaces');
                    const data = await response.json();
                    this.currentData.interfaces = data.success ? data.interfaces : null;
                    this.updateInterfaces();
                } catch (error) {
                    this.currentData.interfaces = null;
                    this.updateInterfaces();
                }
            }

            async fetchAndRenderPPPoE() {
                try {
                    const response = await fetch('/api/pppoe');
                    const data = await response.json();
                    this.currentData.pppoe = data.success ? data : null;
                    this.updatePPPoE();
                    // Also update network summary if stats are present
                    this.updateNetworkSummary();
                } catch (error) {
                    this.currentData.pppoe = null;
                    this.updatePPPoE();
                }
            }

            async fetchAndRenderPPPActive() {
                try {
                    const response = await fetch('/api/ppp_active');
                    const data = await response.json();
                    this.currentData.ppp_active = data.success ? data.ppp_active : null;
                    this.updatePPPActive();
                } catch (error) {
                    this.currentData.ppp_active = null;
                    this.updatePPPActive();
                }
            }

            async fetchAndRenderPPPAccounts() {
                try {
                    const response = await fetch('/api/ppp_accounts');
                    const data = await response.json();
                    this.currentData.ppp_accounts = data.success ? data.ppp_accounts : null;
                    this.updatePPPAccounts();
                } catch (error) {
                    this.currentData.ppp_accounts = null;
                    this.updatePPPAccounts();
                }
            }

            updateUI() {
                this.updateNetworkSummary();
                this.updateResources();
                this.updateInterfaces();
                this.updatePPPoE();
                this.updatePPPActive();
                this.updatePPPAccounts();
                this.updateFooter();
                this.updatePaginationControls();
            }

            updateNetworkSummary() {
                if (this.currentData.pppoe && this.currentData.pppoe.aggregate_stats) {
                    const stats = this.currentData.pppoe.aggregate_stats;
                    document.getElementById('total-accounts').textContent = stats.total_accounts || 0;
                    document.getElementById('online-accounts').textContent = stats.online_accounts || 0;
                    document.getElementById('offline-accounts').textContent = stats.offline_accounts || 0;
                    document.getElementById('enabled-accounts').textContent = stats.enabled_accounts || 0;
                    document.getElementById('disabled-accounts').textContent = stats.disabled_accounts || 0;
                }

                // Update speeds (placeholder for now)
                document.getElementById('total-upload-speed').textContent = 'Calculating...';
                document.getElementById('total-download-speed').textContent = 'Calculating...';
            }

            updateResources() {
                const section = document.getElementById('resources-section');
                const content = document.getElementById('resources-content');
                
                if (this.currentData.resources) {
                    section.style.display = 'block';
                    content.innerHTML = this.renderResources(this.currentData.resources);
                } else {
                    section.style.display = 'none';
                }
            }

            renderResources(resources) {
                return `
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="resource-card">
                            <h4>CPU Load</h4>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${resources['cpu-load'] || 0}%"
                                     aria-valuenow="${resources['cpu-load'] || 0}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    ${resources['cpu-load'] || 0}%
                                </div>
                            </div>
                            <small class="text-muted">
                                ${resources['cpu-count'] || 1} CPU(s), ${resources['cpu-frequency'] || 'N/A'} MHz
                            </small>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="resource-card">
                            <h4>Memory Usage</h4>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${resources.memory_percentage || 0}%"
                                     aria-valuenow="${resources.memory_percentage || 0}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    ${(resources.memory_percentage || 0).toFixed(1)}%
                                </div>
                            </div>
                            <small class="text-muted">
                                ${this.formatBytes(resources.memory_used || 0)} / ${this.formatBytes(resources['total-memory'] || 0)}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="resource-card">
                            <h4>HDD Usage</h4>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${resources.hdd_percentage || 0}%"
                                     aria-valuenow="${resources.hdd_percentage || 0}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    ${(resources.hdd_percentage || 0).toFixed(1)}%
                                </div>
                            </div>
                            <small class="text-muted">
                                ${this.formatBytes(resources.hdd_used || 0)} / ${this.formatBytes(resources['total-hdd-space'] || 0)}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="resource-card">
                            <h4>Uptime</h4>
                            <p class="mb-0">${resources.uptime || 'N/A'}</p>
                            <small class="text-muted">
                                Version: ${resources.version || 'N/A'}
                            </small>
                        </div>
                    </div>
                `;
            }

            updateInterfaces() {
                const section = document.getElementById('interfaces-section');
                const tbody = document.querySelector('#network-interfaces-table tbody');
                const data = this.currentData.interfaces ? this.currentData.interfaces.filter(iface => iface.type !== 'pppoe-in') : [];
                const total = data.length;
                const start = (this.interfacesPage - 1) * this.rowsPerPage;
                const end = Math.min(start + this.rowsPerPage, total);
                const pageData = data.slice(start, end);
                if (data.length > 0) {
                    section.style.display = 'block';
                    tbody.innerHTML = pageData.map(iface => `
                        <tr class="${iface.running === 'true' ? 'table-default' : 'table-secondary'} interface-row${iface.name.toLowerCase().includes('pppoe') ? ' pppoe-interface' : ''}">
                            <td>${iface.name || 'N/A'}</td>
                            <td>${iface.type || 'N/A'}</td>
                            <td>
                                <span class="status-indicator ${iface.running === 'true' ? 'status-up' : 'status-down'}"></span>
                                ${iface.running === 'true' ? 'Up' : 'Down'}
                            </td>
                            <td>${iface['mac-address'] || 'N/A'}</td>
                        </tr>
                    `).join('');
                    document.getElementById('interfaces-showing-start').textContent = total === 0 ? 0 : start + 1;
                    document.getElementById('interfaces-showing-end').textContent = end;
                    document.getElementById('interfaces-total-rows').textContent = total;
                    document.getElementById('interfaces-current-page').textContent = this.interfacesPage;
                } else {
                    section.style.display = 'none';
                }
            }

            updatePPPoE() {
                const section = document.getElementById('pppoe-section');
                const tbody = document.querySelector('#pppoe-interfaces-table tbody');
                // Build a map of PPP account name and username (case-insensitive) -> account for quick lookup
                const pppAccounts = (this.currentData.ppp_accounts || []);
                const pppAccountMap = {};
                pppAccounts.forEach(acc => {
                    if (acc.name) pppAccountMap[acc.name.toLowerCase()] = acc;
                    if (acc.username) pppAccountMap[acc.username.toLowerCase()] = acc;
                });
                const data = this.currentData.pppoe && this.currentData.pppoe.pppoe_interfaces ? this.currentData.pppoe.pppoe_interfaces : [];
                const total = data.length;
                const start = (this.pppoePage || 1) - 1 >= 0 ? ((this.pppoePage || 1) - 1) * this.rowsPerPage : 0;
                const end = Math.min(start + this.rowsPerPage, total);
                const pageData = data.slice(start, end);
                if (data.length > 0) {
                    section.style.display = 'block';
                    tbody.innerHTML = pageData.map(iface => {
                        // Try to match PPPoE interface name to PPP account by name or username (case-insensitive)
                        let acc = null;
                        if (iface.name) {
                            acc = pppAccountMap[iface.name.toLowerCase()];
                            // Also try to extract username from interface name if it matches <pppoe-username>
                            const match = iface.name.match(/^<pppoe-(.+)>$/i);
                            if (!acc && match && match[1]) {
                                acc = pppAccountMap[match[1].toLowerCase()];
                            }
                        }
                        const name = acc ? acc.name : (iface.name || 'N/A');
                        const profile = acc ? acc.profile : (iface.profile || 'N/A');
                        return `
                        <tr class="${iface.running === 'true' ? 'table-default' : 'table-secondary'}">
                            <td>${name}</td>
                            <td>${profile}</td>
                            <td>
                                <span class="status-indicator ${iface.running === 'true' ? 'status-up' : 'status-down'}"></span>
                                ${iface.running === 'true' ? 'Up' : 'Down'}
                            </td>
                            <td>${this.formatBytes(iface['tx-byte'] || 0)}</td>
                            <td>${this.formatBytes(iface['rx-byte'] || 0)}</td>
                            <td>${iface.address || 'N/A'}</td>
                            <td>${iface.uptime || 'N/A'}</td>
                        </tr>
                        `;
                    }).join('');
                    document.getElementById('pppoe-showing-start').textContent = total === 0 ? 0 : start + 1;
                    document.getElementById('pppoe-showing-end').textContent = end;
                    document.getElementById('pppoe-total-rows').textContent = total;
                    document.getElementById('pppoe-current-page').textContent = this.pppoePage || 1;
                } else {
                    section.style.display = 'none';
                }
            }

            updatePPPActive() {
                const section = document.getElementById('ppp-active-section');
                const content = document.getElementById('ppp-active-content');
                const data = this.currentData.ppp_active || [];
                const total = data.length;
                const start = (this.pppActivePage - 1) * this.rowsPerPage;
                const end = Math.min(start + this.rowsPerPage, total);
                const pageData = data.slice(start, end);
                if (data.length > 0) {
                    section.style.display = 'block';
                    content.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Service</th>
                                        <th>Address</th>
                                        <th>Uptime</th>
                                        <th>Bytes In/Out</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageData.map(conn => `
                                        <tr>
                                            <td>${conn.name || 'N/A'}</td>
                                            <td>${conn.service || 'N/A'}</td>
                                            <td>${conn.address || 'N/A'}</td>
                                            <td>${conn.uptime || 'N/A'}</td>
                                            <td>${this.formatBytes(conn['bytes-in'] || 0)} / ${this.formatBytes(conn['bytes-out'] || 0)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    document.getElementById('ppp-active-showing-start').textContent = total === 0 ? 0 : start + 1;
                    document.getElementById('ppp-active-showing-end').textContent = end;
                    document.getElementById('ppp-active-total-rows').textContent = total;
                    document.getElementById('ppp-active-current-page').textContent = this.pppActivePage;
                } else {
                    section.style.display = 'block';
                    content.innerHTML = '<div class="alert alert-info">No active PPP connections</div>';
                    document.getElementById('ppp-active-showing-start').textContent = 0;
                    document.getElementById('ppp-active-showing-end').textContent = 0;
                    document.getElementById('ppp-active-total-rows').textContent = 0;
                    document.getElementById('ppp-active-current-page').textContent = 1;
                }
            }

            updatePPPAccounts() {
                const section = document.getElementById('ppp-accounts-section');
                const content = document.getElementById('ppp-accounts-content');
                const data = this.currentData.ppp_accounts || [];
                const total = data.length;
                const start = (this.pppAccountsPage - 1) * this.rowsPerPage;
                const end = Math.min(start + this.rowsPerPage, total);
                const pageData = data.slice(start, end);
                if (data.length > 0) {
                    section.style.display = 'block';
                    content.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Service</th>
                                        <th>Profile</th>
                                        <th>Status</th>
                                        <th>Last Logged Out</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageData.map(account => `
                                        <tr>
                                            <td>${account.name || 'N/A'}</td>
                                            <td>${account.service || 'N/A'}</td>
                                            <td>${account.profile || 'N/A'}</td>
                                            <td>
                                                ${account.disabled === 'true' 
                                                    ? '<span class="badge bg-danger">Disabled</span>' 
                                                    : '<span class="badge bg-success">Enabled</span>'}
                                            </td>
                                            <td>${account['last-logged-out'] || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    section.style.display = 'block';
                    content.innerHTML = '<div class="alert alert-info">No PPP accounts configured</div>';
                }
            }

            updateFooter() {
                const now = new Date().toLocaleString();
                document.getElementById('footer-time').textContent = now;
                document.getElementById('last-updated-time').textContent = now;
            }

            applyInterfaceFilter() {
                const filterValue = document.getElementById('interface-filter').value.toLowerCase();
                const tableRows = document.querySelectorAll('#network-interfaces-table tbody tr');
                
                tableRows.forEach(row => {
                    const interfaceName = row.cells[0].textContent.toLowerCase();
                    const interfaceType = row.cells[1].textContent.toLowerCase();
                    
                    if (filterValue === 'no-pppoe') {
                        if (interfaceName.includes('pppoe') || interfaceType.includes('pppoe')) {
                            row.style.display = 'none';
                        } else {
                            row.style.display = '';
                        }
                    } else if (filterValue === 'all' || 
                        interfaceName.includes(filterValue) || 
                        interfaceType.includes(filterValue)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            setRefreshInterval(seconds) {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
                
                const display = document.getElementById('refresh-interval-display');
                display.textContent = seconds > 0 ? seconds + ' seconds' : 'Off';
                
                if (seconds > 0) {
                    this.refreshInterval = setInterval(() => {
                        this.refreshAllData();
                    }, seconds * 1000);
                }
                
                localStorage.setItem('refreshInterval', seconds.toString());
            }

            async exportData() {
                try {
                    showInfo('Export Started', 'Preparing data for download...');
                    const response = await fetch('/api/export');
                    const data = await response.json();
                    
                    if (data.success) {
                        const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `mikrotik-export-${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        showSuccess('Export Complete', 'Data exported successfully');
                    } else {
                        showError('Export Failed', data.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    showError('Export Error', 'Failed to export data');
                }
            }

            testNotifications() {
                showSuccess('Success Notification', 'This is a success message with 2-second delay');
                setTimeout(() => {
                    showError('Error Notification', 'This is an error message with 2-second delay');
                }, 1000);
                setTimeout(() => {
                    showWarning('Warning Notification', 'This is a warning message with 2-second delay');
                }, 2000);
                setTimeout(() => {
                    showInfo('Info Notification', 'This is an info message with 2-second delay');
                }, 3000);
            }

            formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            updatePaginationControls() {
                setTimeout(() => {
                    // Network Interfaces
                    const prevInt = document.getElementById('interfaces-prev-page');
                    const nextInt = document.getElementById('interfaces-next-page');
                    if (prevInt && nextInt) {
                        prevInt.onclick = () => { if (this.interfacesPage > 1) { this.interfacesPage--; this.updateInterfaces(); } };
                        nextInt.onclick = () => { const total = (this.currentData.interfaces ? this.currentData.interfaces.filter(iface => iface.type !== 'pppoe-in').length : 0); if (this.interfacesPage * this.rowsPerPage < total) { this.interfacesPage++; this.updateInterfaces(); } };
                    }
                    // PPPoE Interfaces
                    const prevPPPoE = document.getElementById('pppoe-prev-page');
                    const nextPPPoE = document.getElementById('pppoe-next-page');
                    if (prevPPPoE && nextPPPoE) {
                        prevPPPoE.onclick = () => { if ((this.pppoePage || 1) > 1) { this.pppoePage = (this.pppoePage || 1) - 1; this.updatePPPoE(); } };
                        nextPPPoE.onclick = () => { const total = (this.currentData.pppoe && this.currentData.pppoe.pppoe_interfaces ? this.currentData.pppoe.pppoe_interfaces.length : 0); if ((this.pppoePage || 1) * this.rowsPerPage < total) { this.pppoePage = (this.pppoePage || 1) + 1; this.updatePPPoE(); } };
                    }
                    // PPP Accounts
                    const prevAcc = document.getElementById('ppp-accounts-prev-page');
                    const nextAcc = document.getElementById('ppp-accounts-next-page');
                    if (prevAcc && nextAcc) {
                        prevAcc.onclick = () => { if (this.pppAccountsPage > 1) { this.pppAccountsPage--; this.updatePPPAccounts(); } };
                        nextAcc.onclick = () => { const total = (this.currentData.ppp_accounts ? this.currentData.ppp_accounts.length : 0); if (this.pppAccountsPage * this.rowsPerPage < total) { this.pppAccountsPage++; this.updatePPPAccounts(); } };
                    }
                    // PPP Active
                    const prevAct = document.getElementById('ppp-active-prev-page');
                    const nextAct = document.getElementById('ppp-active-next-page');
                    if (prevAct && nextAct) {
                        prevAct.onclick = () => { if (this.pppActivePage > 1) { this.pppActivePage--; this.updatePPPActive(); } };
                        nextAct.onclick = () => { const total = (this.currentData.ppp_active ? this.currentData.ppp_active.length : 0); if (this.pppActivePage * this.rowsPerPage < total) { this.pppActivePage++; this.updatePPPActive(); } };
                    }
                }, 0);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            window.monitor = new MikroTikMonitor();
            // Load saved refresh interval
            const savedInterval = localStorage.getItem('refreshInterval');
            if (savedInterval) {
                window.monitor.setRefreshInterval(parseInt(savedInterval));
            }
            // Instantly load all data on page load
            window.monitor.refreshAllData();
        });
    </script>
</body>
</html> 