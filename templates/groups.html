{% extends "base.html" %}

{% block title %}Account Groups Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header with Add Group button -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h1>Account Groups</h1>
        </div>
        <div class="col-md-6 text-end">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGroupModal">
                <i class="bi bi-plus-circle"></i> Add New Group
            </button>
        </div>
    </div>
    
    <!-- No groups message -->
    <div class="alert alert-info" id="no-groups-message" style="display: none;">
        No groups have been created yet. Click the "Add Group" button to create a new group.
    </div>
    
    <!-- Groups Container -->
    <div class="row" id="groups-container">
        <!-- Groups will be dynamically inserted here -->
        <div class="col-12 text-center py-5" id="no-groups-message">
            <h3 class="text-muted">No groups created yet</h3>
            <p>Create a new group to monitor sets of accounts together</p>
        </div>
    </div>
</div>

<!-- Add Group Modal -->
<div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGroupModalLabel">Add New Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-group-form">
                    <div class="mb-3">
                        <label for="group-name" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="group-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Accounts</label>
                        <div class="account-list-container border rounded p-2 mb-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check" id="accounts-loading">
                                <label class="form-check-label">Loading accounts...</label>
                            </div>
                            <div id="accounts-list">
                                <!-- Account checkboxes will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-group-btn">Save Group</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Group Modal -->
<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGroupModalLabel">Edit Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-group-form">
                    <input type="hidden" id="edit-group-id">
                    <div class="mb-3">
                        <label for="edit-group-name" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="edit-group-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Accounts</label>
                        <div class="account-list-container border rounded p-2 mb-2" style="max-height: 200px; overflow-y: auto;">
                            <div id="edit-accounts-list">
                                <!-- Account checkboxes will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="delete-group-btn">Delete Group</button>
                <button type="button" class="btn btn-primary" id="update-group-btn">Update Group</button>
            </div>
        </div>
    </div>
</div>

<!-- Group Card Template (hidden, will be cloned by JavaScript) -->
<template id="group-card-template">
    <div class="col-md-4 mb-4 group-card">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="group-name mb-0">Group Name</h5>
                <button class="btn btn-sm btn-outline-primary edit-group-btn" data-group-id="">
                    Edit
                </button>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <div>
                        <span class="badge bg-success me-1">Online: <span class="online-count">0</span></span>
                        <span class="badge bg-danger">Offline: <span class="offline-count">0</span></span>
                    </div>
                    <div>
                        <span class="badge bg-info">Total: <span class="total-count">0</span></span>
                    </div>
                </div>
                <div class="account-list small" style="max-height: 100px; overflow-y: auto;">
                    <!-- Account list will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Add JavaScript for group functionality -->
<script>
// Global variables
let allAccounts = [];
let refreshTimer = null;
const refreshInterval = 30000; // 30 seconds

// Load all accounts for selection
function loadAccounts() {
    fetch('/api/accounts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allAccounts = data.accounts;
                renderAccountsCheckboxes();
            } else {
                console.error('Failed to load accounts:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching accounts:', error);
        });
}

// Render account checkboxes in the modals
function renderAccountsCheckboxes(selectedAccounts = []) {
    // For Add modal
    const accountsList = document.getElementById('accounts-list');
    const loadingIndicator = document.getElementById('accounts-loading');
    
    if (accountsList) {
        // Clear loading indicator
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        // Create account checkboxes
        accountsList.innerHTML = '';
        
        // Sort accounts by name
        allAccounts.sort((a, b) => a.name.localeCompare(b.name));
        
        allAccounts.forEach(account => {
            const isSelected = selectedAccounts.includes(account.name);
            const isDisabled = account.disabled === true;
            const statusClass = account.status === 'online' ? 'text-success' : 'text-danger';
            
            const checkbox = document.createElement('div');
            checkbox.className = 'form-check';
            checkbox.innerHTML = `
                <input class="form-check-input account-checkbox" type="checkbox" value="${account.name}" 
                       id="account-${account.name}" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                <label class="form-check-label ${statusClass}" for="account-${account.name}">
                    ${account.name} (${account.profile}) - <span class="${statusClass}">${account.status}</span>
                </label>
            `;
            accountsList.appendChild(checkbox);
        });
    }
    
    // For Edit modal
    const editAccountsList = document.getElementById('edit-accounts-list');
    if (editAccountsList) {
        // Create account checkboxes
        editAccountsList.innerHTML = '';
        
        allAccounts.forEach(account => {
            const isSelected = selectedAccounts.includes(account.name);
            const isDisabled = account.disabled === true;
            const statusClass = account.status === 'online' ? 'text-success' : 'text-danger';
            
            const checkbox = document.createElement('div');
            checkbox.className = 'form-check';
            checkbox.innerHTML = `
                <input class="form-check-input edit-account-checkbox" type="checkbox" value="${account.name}" 
                       id="edit-account-${account.name}" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                <label class="form-check-label ${statusClass}" for="edit-account-${account.name}">
                    ${account.name} (${account.profile}) - <span class="${statusClass}">${account.status}</span>
                </label>
            `;
            editAccountsList.appendChild(checkbox);
        });
    }
}

// Get selected accounts from the modal
function getSelectedAccounts(checkboxClass) {
    const selected = [];
    document.querySelectorAll(`.${checkboxClass}:checked`).forEach(checkbox => {
        selected.push(checkbox.value);
    });
    return selected;
}

// Create a new group
function createGroup() {
    const name = document.getElementById('group-name').value.trim();
    if (!name) {
        alert('Please enter a group name');
        return;
    }
    
    const accounts = getSelectedAccounts('account-checkbox');
    
    fetch('/api/groups', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            accounts: accounts
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addGroupModal'));
            modal.hide();
            
            // Reset the form
            document.getElementById('add-group-form').reset();
            
            // Reload groups
            loadGroups();
        } else {
            alert(`Failed to create group: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error creating group:', error);
        alert('An error occurred while creating the group');
    });
}

// Load and render all groups
function loadGroups() {
    fetch('/api/groups')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderGroups(data.groups);
            } else {
                console.error('Failed to load groups');
            }
        })
        .catch(error => {
            console.error('Error fetching groups:', error);
        });
}

// Render groups as cards
function renderGroups(groups) {
    const container = document.getElementById('groups-container');
    const noGroupsMessage = document.getElementById('no-groups-message');
    
    // Clear container
    container.innerHTML = '';
    
    // Show/hide no groups message
    if (groups.length === 0) {
        noGroupsMessage.style.display = 'block';
        return;
    } else {
        noGroupsMessage.style.display = 'none';
    }
    
    // Create group cards
    groups.forEach(group => {
        // Clone the template
        const template = document.getElementById('group-card-template');
        const card = template.content.cloneNode(true);
        
        // Set group name
        card.querySelector('.group-name').textContent = group.name;
        
        // Set edit button data
        card.querySelector('.edit-group-btn').dataset.groupId = group.id;
        
        // Set status counts
        card.querySelector('.online-count').textContent = group.online_count || 0;
        card.querySelector('.offline-count').textContent = group.offline_count || 0;
        card.querySelector('.total-count').textContent = (group.accounts || []).length;
        
        // Set card color based on status
        const cardElement = card.querySelector('.card');
        if (group.status === 'green') {
            cardElement.classList.add('border-success');
            cardElement.querySelector('.card-header').classList.add('bg-success', 'text-white');
        } else if (group.status === 'red') {
            cardElement.classList.add('border-danger');
            cardElement.querySelector('.card-header').classList.add('bg-danger', 'text-white');
        } else if (group.status === 'yellow') {
            cardElement.classList.add('border-warning');
            cardElement.querySelector('.card-header').classList.add('bg-warning');
        } else if (group.status === 'yellowgreen') {
            cardElement.classList.add('border-success');
            cardElement.querySelector('.card-header').classList.add('bg-success', 'bg-opacity-50');
        }
        
        // Populate accounts list
        const accountsList = card.querySelector('.account-list');
        if (group.accounts && group.accounts.length > 0) {
            group.accounts.forEach(account => {
                const isOnline = group.online_accounts && group.online_accounts.includes(account);
                const accountItem = document.createElement('div');
                accountItem.className = isOnline ? 'text-success' : 'text-danger';
                accountItem.textContent = account;
                accountsList.appendChild(accountItem);
            });
        } else {
            const noAccounts = document.createElement('div');
            noAccounts.className = 'text-muted';
            noAccounts.textContent = 'No accounts in this group';
            accountsList.appendChild(noAccounts);
        }
        
        // Add card to container
        container.appendChild(card);
    });
    
    // Add event listeners to edit buttons
    document.querySelectorAll('.edit-group-btn').forEach(button => {
        button.addEventListener('click', function() {
            const groupId = this.dataset.groupId;
            openEditModal(groupId);
        });
    });
}

// Open the edit modal for a group
function openEditModal(groupId) {
    fetch(`/api/groups/${groupId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.group) {
                const group = data.group;
                
                // Set form fields
                document.getElementById('edit-group-id').value = group.id;
                document.getElementById('edit-group-name').value = group.name;
                
                // Set selected accounts
                renderAccountsCheckboxes(group.accounts || []);
                
                // Open modal
                const modal = new bootstrap.Modal(document.getElementById('editGroupModal'));
                modal.show();
            } else {
                alert('Failed to load group details');
            }
        })
        .catch(error => {
            console.error('Error loading group details:', error);
            alert('An error occurred while loading group details');
        });
}

// Update an existing group
function updateGroup() {
    const groupId = document.getElementById('edit-group-id').value;
    const name = document.getElementById('edit-group-name').value.trim();
    
    if (!name) {
        alert('Please enter a group name');
        return;
    }
    
    const accounts = getSelectedAccounts('edit-account-checkbox');
    
    fetch(`/api/groups/${groupId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            accounts: accounts
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editGroupModal'));
            modal.hide();
            
            // Reload groups
            loadGroups();
        } else {
            alert(`Failed to update group: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error updating group:', error);
        alert('An error occurred while updating the group');
    });
}

// Delete a group
function deleteGroup() {
    const groupId = document.getElementById('edit-group-id').value;
    
    if (!confirm('Are you sure you want to delete this group?')) {
        return;
    }
    
    fetch(`/api/groups/${groupId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editGroupModal'));
            modal.hide();
            
            // Reload groups
            loadGroups();
        } else {
            alert(`Failed to delete group: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error deleting group:', error);
        alert('An error occurred while deleting the group');
    });
}

// Setup auto refresh
function setupAutoRefresh() {
    // Clear any existing timer
    if (refreshTimer) {
        clearInterval(refreshTimer);
    }
    
    // Set up new timer
    refreshTimer = setInterval(() => {
        loadGroups();
    }, refreshInterval);
}

// Initialize when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Load accounts and groups
    loadAccounts();
    loadGroups();
    
    // Set up event handlers
    document.getElementById('save-group-btn').addEventListener('click', createGroup);
    document.getElementById('update-group-btn').addEventListener('click', updateGroup);
    document.getElementById('delete-group-btn').addEventListener('click', deleteGroup);
    
    // Setup auto refresh
    setupAutoRefresh();
});
</script>
{% endblock %}
